version: 2
jobs:
  build:
    working_directory: /tmp/build
    docker:
      - image: spikerlabs/angular4-cli
    steps:
      - checkout
      - run:
          name: install git
          command: apk add --no-cache git
# todo: configure tests to run in CI
#      - run:
#          name: Run test
#          command: ng test
      - run:
          name: Install all dependencies
          command: npm install
      - run:
          name: Build distribution
          command: ng build --environment prod
      - setup_remote_docker
      - run:
          name: Build docker image
          command: |
            apk add --no-cache docker
            docker build -t "spikerlabs/scala-fun-frontend:$(git describe --tags)" .
      - deploy:
          name: Publish to Docker Hub
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              docker login -u ${DOCKER_LOGIN} -p ${DOCKER_PASSWORD}
              docker push "spikerlabs/scala-fun-frontend:$(git describe --tags)"
            fi
